// SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause)
/*
 * Copyright (C) PHYTEC GmbH 2019-2020 - All Rights Reserved
 * Author: Dom VOVARD <dom.vovard@linrt.com>.
 */

#include "phyboard-stm32mp1-pinctrl.dtsi"
#include <dt-bindings/leds/leds-pca9532.h>

/ {
        model = "Phytec GmbH phycore-stm32mp1 Sargas Dev Board";
        compatible = "phytec,pcm939-1517-2", "st,stm32mp157";

	aliases {
		ethernet0 = &ethernet0;
		rtc0	= &i2c4_rtc;
		rtc1	= &rtc;
		serial0 = &uart4;
                serial1 = &usart3;
                serial2 = &usart1;
        };

	chosen {
		stdout-path = "serial0:115200n8";
	};

        sound {
                compatible = "audio-graph-card";
                label = "STM32MP1-PHYCORE";
                routing =
			"Playback", "MCLK", /* Set a route between "MCLK" and "playback" widgets */
			"Capture", "MCLK";
                dais = <&sai2b_port &sai2a_port>;
                status = "okay";
        };

	gpio-keys {
		compatible = "gpio-keys";
		status = "okay";

		home {
			label = "Home";
			gpios = <&gpioa 13 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_HOME>;
		};

		enter {
			label = "Enter";
			gpios = <&gpioa 14 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_ENTER>;
		};
	};

	usb_phy_tuning: usb-phy-tuning {
		st,hs-dc-level = <2>;
		st,fs-rftime-tuning;
		st,hs-rftime-reduction;
		st,hs-current-trim = <15>;
		st,hs-impedance-trim = <1>;
		st,squelch-level = <3>;
		st,hs-rx-offset = <2>;
		st,no-lsfs-sc;
	};

	reg_m_can: regulator-mcan {
		compatible = "regulator-fixed";
		regulator-name = "mcan-reg";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		gpio = <&gpiog 1 GPIO_ACTIVE_HIGH>;
		status = "okay";
	};
};

&m_can2 {
        pinctrl-names = "default", "sleep";
        pinctrl-0 = <&m_can2_pins_a>;
        pinctrl-1 = <&m_can2_sleep_pins_a>;
	 xceiver-supply = <&reg_m_can>;
        status = "okay";
};

&i2c1 {
        pinctrl-names = "default", "sleep";
        pinctrl-0 = <&i2c1_pins_a>;
        pinctrl-1 = <&i2c1_pins_sleep_a>;
        i2c-scl-rising-time-ns = <100>;
        i2c-scl-falling-time-ns = <7>;
        status = "okay";
        /delete-property/dmas;
        /delete-property/dma-names;

        codec: tlv320@18 {
                compatible = "ti,tlv320aic3007";
                #sound-dai-cells = <0>;
                reg = <0x18>;
		status = "okay";

                ai3x-micbias-vg = <2>;

                /* gpio-reset = <&gpio5 8 GPIO_ACTIVE_LOW>; */
                AVDD-supply = <&v3v3>;
                IOVDD-supply = <&v3v3>;
                DRVDD-supply = <&v3v3>;
                DVDD-supply = <&v1v8_audio>;

                clocks = <&sai2b>;
                clock-names = "MCLK";



		tlv320_port: port {
			#address-cells = <1>;
			#size-cells = <0>;

			tlv320_tx_endpoint: endpoint@0 {
                                reg = <0>;
				remote-endpoint = <&sai2b_endpoint>;
                                frame-master;
                                bitclock-master;
			};

			tlv320_rx_endpoint: endpoint@1 {
                                reg = <1>;
				remote-endpoint = <&sai2a_endpoint>;
                                frame-master;
                                bitclock-master;
			};
		};
        };

	stmpe_touch: stmpe811@44 {
		compatible = "st,stmpe811";
		reg = <0x44>;
                interrupts = <3 2>;
                interrupt-parent = <&gpioi>;
		vio-supply = <&v3v3>;
		vcc-supply = <&v3v3>;
                status = "disabled";

		stmpe_touchscreen {
			compatible = "st,stmpe-ts";
			st,sample-time = <4>;
			st,mod-12b = <1>;
			st,ref-sel = <0>;
			st,adc-freq = <1>;
			st,ave-ctrl = <1>;
			st,touch-det-delay = <2>;
			st,settling = <2>;
			st,fraction-z = <7>;
			st,i-drive = <1>;
		};
	};

	leds: pca9533@62 {
		compatible = "nxp,pca9533";
		reg = <0x62>;
		status = "okay";

		red-power {
			label = "pca:red:power";
			type = <PCA9532_TYPE_LED>;
		};

		green-power {
			label = "pca:green:power";
			type = <PCA9532_TYPE_LED>;
		};

		blue-power {
			type = <PCA9532_TYPE_LED>;
			linux,default-trigger = "heartbeat";
		};
	};
};

&i2c2 {
	status = "disabled";
};


&sai2 {
	clocks = <&rcc SAI2>, <&rcc PLL3_Q>, <&rcc PLL3_R>;
	clock-names = "pclk", "x8k", "x11k";
	pinctrl-names = "default", "sleep";
	pinctrl-0 = <&sai2a_pins_b>, <&sai2b_pins_a>;
	pinctrl-1 = <&sai2a_sleep_pins_b>, <&sai2b_sleep_pins_a>;
	status = "okay";

        sai2a: audio-controller@4400b004 {
                compatible = "st,stm32-sai-sub-a";
		dma-names = "rx";
		st,sync = <&sai2b 2>;
		status = "okay";
		clocks = <&rcc SAI2_K>, <&sai2b>;
		clock-names = "sai_ck", "MCLK";

		sai2a_port: port {
			sai2a_endpoint: endpoint {
				remote-endpoint = <&tlv320_rx_endpoint>;
				format = "i2s";
				mclk-fs = <256>;
                                dai-tdm-slot-num = <2>;
                                dai-tdm-slot-width = <16>;
			};
		};
	};

        sai2b: audio-controller@4400b024 {
		compatible = "st,stm32-sai-sub-b";
                #clock-cells = <0>;
                dma-names = "tx";
                clocks = <&rcc SAI2_K>;
                clock-names = "sai_ck";
                status = "okay";

                sai2b_port: port {
                        sai2b_endpoint: endpoint {
                                remote-endpoint = <&tlv320_tx_endpoint>;
                                format = "i2s";
                                mclk-fs = <256>;
                                dai-tdm-slot-num = <2>;
                                dai-tdm-slot-width = <16>;
                        };
                };
        };
};

&sdmmc1 {
	pinctrl-names = "default", "opendrain", "sleep";
	pinctrl-0 = <&sdmmc1_b4_pins_a>;
	pinctrl-1 = <&sdmmc1_b4_od_pins_a>;
	pinctrl-2 = <&sdmmc1_b4_sleep_pins_a>;
	cd-gpios = <&gpiof 3 GPIO_ACTIVE_LOW>;  
	st,neg-edge;
	bus-width = <4>;
	max-frequency = <10000000>;
	vmmc-supply = <&v3v3>;
	status = "okay";
};


&spi1 {
        pinctrl-names = "default", "sleep";
        pinctrl-0 = <&spi1_pins_a>;
        pinctrl-1 = <&spi1_sleep_pins_a>;
        status = "okay";
};


&uart4 {
	pinctrl-names = "default", "sleep", "idle", "no_console_suspend";
	pinctrl-0 = <&uart4_pins_a>;
	pinctrl-1 = <&uart4_sleep_pins_a>;
	pinctrl-2 = <&uart4_idle_pins_a>;
	pinctrl-3 = <&uart4_pins_a>;
	status = "okay";
};

&usart1 {
        pinctrl-names = "default", "sleep", "idle";
        pinctrl-0 = <&usart1_pins_a &usart1_pins_b>;
        pinctrl-1 = <&usart1_sleep_pins_a &usart1_sleep_pins_b>;
        pinctrl-2 = <&usart1_idle_pins_a &usart1_idle_pins_b>;
        /*st,hw-flow-ctrl;*/
	/*linux,rs485-enabled-at-boot-time;*/
        status = "okay";
};

&usart3 {
	pinctrl-names = "default", "sleep", "idle";
	pinctrl-0 = <&usart3_pins_b>;
	pinctrl-1 = <&usart3_sleep_pins_b>;
	pinctrl-2 = <&usart3_idle_pins_b>;
	status = "okay";
};

&usbh_ehci {
	phys = <&usbphyc_port0>;
	phy-names = "usb";
	status = "okay";
        vbus-supply = <&vbus_sw>;
};

&usbh_ohci {
        phys = <&usbphyc_port0>;
        phy-names = "usb";
        status = "okay";
        vbus-supply = <&vbus_sw>;
};

&usbotg_hs {
	force-b-session-valid;
	phys = <&usbphyc_port1 0>;
	phy-names = "usb2-phy";
	vbus-supply = <&vbus_otg>;
	status = "okay";
};

&usbphyc {
	vdd3v3-supply = <&vdd_usb>;
	status = "okay";
};

&usbphyc_port0 {
	st,phy-tuning = <&usb_phy_tuning>;
};

&usbphyc_port1 {
	st,phy-tuning = <&usb_phy_tuning>;
};

&vrefbuf {
	regulator-min-microvolt = <2500000>;
	regulator-max-microvolt = <2500000>;
	vdda-supply = <&vdd>;
	status = "disabled";
};

/* Select display interface by commenting/uncommenting the following lines */ 
//#include "phycore-stm32mp1-dsi-lcd-mb1407.dtsi"
//#include "phycore-stm32mp1-dsi-rpi-official-display.dtsi"
//#include "phycore-stm32mp1-peb-av01-hdmi.dtsi"
#include "phycore-stm32mp1-peb-av02-lcd.dtsi"


/* Selected connectors used commenting/uncommenting the following line  */ 
#include "phycore-stm32mp1-pi-hat-extension.dtsi"
//#include "phycore-stm32mp1-pi-hat-redbear.dtsi"
//#include "phycore-stm32mp1-uno-r3-extension.dtsi"
